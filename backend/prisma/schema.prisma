/*
KEYWORDS:
- CONFIGURATION
- ENUMERATIONS
- MODELS
*/

// CONFIGURATION

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ENUMERATIONS
enum UserStatus {
  ACTIVE    // Đang hoạt động (mặc định) [cite: 161]
  SUSPENDED // Bị treo tài khoản
  BANNED    // Bị cấm
}

enum OrderStatus {
  PENDING    // Mới tạo, chờ xử lý (mặc định) [cite: 194]
  PROCESSING // Đang xử lý (đã xác nhận, đang đóng gói)
  SHIPPING   // Đang vận chuyển
  DELIVERED  // Đã giao hàng
  COMPLETED  // Đã hoàn thành (VD: sau khi hết hạn đổi trả)
  CANCELLED  // Đã hủy
  FAILED     // Thất bại (VD: thanh toán thất bại)
}

enum PaymentStatus {
  UNPAID    // Chưa thanh toán (mặc định, VD: COD) [cite: 194]
  PENDING   // Đang chờ thanh toán (VD: chuyển qua cổng VNPAY)
  PAID      // Đã thanh toán
  FAILED    // Thanh toán thất bại
  REFUNDED  // Đã hoàn tiền
}

// MODELS 

model User {
  id                Int      @id @default(autoincrement())
  avatar            String?  @db.VarChar(255)
  name              String   @db.VarChar(255)
  phone             String?  @unique @db.VarChar(20)
  email             String   @unique @db.VarChar(255)
  is_email_verified Boolean  @default(false)
  password_hashed   String   @db.VarChar(255)
  status            UserStatus @default(ACTIVE)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  refresh_tokens UserRefreshToken[]
  addresses      UserAddress[]
  orders         Order[]
  reviews        ProductReview[]
  roles          UserRole[]

  @@map("user")
}

model UserRefreshToken {
  id         String   @id @db.VarChar(255)
  is_invoked Boolean   @default(false)
  invoked_at DateTime?
  user_id    Int
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt

  user       User      @relation(fields: [user_id], references: [id])

  @@unique([id, user_id])
  @@map("user_refresh_token")
}

model UserRole {
  user_id    Int
  role_id    Int
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user       User     @relation(fields: [user_id], references: [id])
  role       Role     @relation(fields: [role_id], references: [id])

  @@id([user_id, role_id])
  @@map("user_role")
}

model Role {
  id         Int      @id @default(autoincrement())
  name       String   @db.VarChar(100)
  code       String   @unique @db.VarChar(50)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  users       UserRole[]
  permissions RolePermission[]

  @@map("role")
}

model Permission {
  id         Int      @id @default(autoincrement())
  name       String   @db.VarChar(255)
  code       String   @unique @db.VarChar(100)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  roles RolePermission[]

  @@map("permission")
}

model RolePermission {
  role_id       Int
  permission_id Int
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  role       Role       @relation(fields: [role_id], references: [id])
  permission Permission @relation(fields: [permission_id], references: [id])

  @@id([role_id, permission_id])
  @@map("role_permission")
}

model UserAddress {
  id             Int      @id @default(autoincrement())
  priority       Int      @default(0)
  address_detail String   @db.VarChar(255)
  user_id        Int
  commune_id     Int
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  user    User    @relation(fields: [user_id], references: [id])
  commune Commune @relation(fields: [commune_id], references: [id])

  @@map("user_address")
}

model Province {
  id         Int      @id @default(autoincrement())
  name       String   @db.VarChar(100)
  code       String   @unique @db.VarChar(20)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  districts  District[]

  @@map("province")
}

model District {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(100)
  code        String   @unique @db.VarChar(20)
  province_id Int
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  province  Province  @relation(fields: [province_id], references: [id])
  communes  Commune[]

  @@map("district")
}

model Commune {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(100)
  code        String   @unique @db.VarChar(20)
  shipping_fee Decimal  @default(0) @db.Decimal(10, 2)
  district_id Int
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  district       District       @relation(fields: [district_id], references: [id])
  user_addresses UserAddress[]
  orders         Order[]

  @@map("commune")
}

model PaymentMethod {
  id          Int       @id @default(autoincrement())
  code        String    @unique @db.VarChar(50)
  name        String    @db.VarChar(100)
  description String?   @db.Text
  is_active   Boolean   @default(true)
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  orders Order[]

  @@map("payment_method")
}

model Order {
  id                Int      @id @default(autoincrement())
  code              String   @unique @db.VarChar(50)
  quantity          Int
  sub_total         Decimal  @db.Decimal(10, 2)
  tax               Decimal  @default(0) @db.Decimal(10, 2)
  discount_amount   Decimal  @default(0) @db.Decimal(10, 2)
  shipping_fee      Decimal  @default(0) @db.Decimal(10, 2)
  total             Decimal  @db.Decimal(10, 2)
  address_detail    String   @db.VarChar(255)
  receiver_name     String   @db.VarChar(255)
  receiver_phone    String   @db.VarChar(20)
  order_status      OrderStatus @default(PENDING)
  payment_status    PaymentStatus @default(UNPAID)
  user_id           Int
  commune_id        Int
  payment_method_id Int
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  user           User           @relation(fields: [user_id], references: [id])
  commune        Commune        @relation(fields: [commune_id], references: [id])
  payment_method PaymentMethod @relation(fields: [payment_method_id], references: [id])
  order_items    OrderItem[]

  @@map("order")
}

model OrderItem {
  id                 Int       @id @default(autoincrement())
  quantity           Int
  unit_price         Decimal   @db.Decimal(10, 2)
  discount_percent   Decimal   @default(0) @db.Decimal(5, 2)
  order_id           Int
  product_variant_id Int
  created_at         DateTime  @default(now())
  updated_at         DateTime  @updatedAt

  order           Order           @relation(fields: [order_id], references: [id])
  product_variant ProductVariant @relation(fields: [product_variant_id], references: [id])
  review          ProductReview?

  @@map("order_item")
}

model ProductReview {
  id            Int       @id @default(autoincrement())
  rating        Int
  comment       String?   @db.Text
  user_id       Int
  order_item_id Int       @unique
  product_id    Int
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  user       User       @relation(fields: [user_id], references: [id])
  order_item OrderItem @relation(fields: [order_item_id], references: [id])
  product    Product    @relation(fields: [product_id], references: [id])

  @@map("product_review")
}

model Category {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(100)
  code      String   @unique @db.VarChar(50)
  parent_id Int?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  parent   Category?  @relation("CategoryTree", fields: [parent_id], references: [id])
  children Category[] @relation("CategoryTree")
  
  products Product[]

  @@map("category")
}

model Product {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(255)
  summary     String?   @db.VarChar(500)
  description String?   @db.Text
  slug        String    @unique @db.VarChar(255)
  gender      String?   @db.VarChar(10)
  category_id Int
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  category  Category         @relation(fields: [category_id], references: [id])
  reviews   ProductReview[]
  variants  ProductVariant[]

  @@map("product")
}

model Size {
  id         Int      @id @default(autoincrement())
  value      String   @db.VarChar(20)
  name       String?  @db.VarChar(50)
  code       String   @unique @db.VarChar(20)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  variants ProductVariant[]

  @@map("size")
}

model Color {
  id         Int      @id @default(autoincrement())
  hex        String?  @db.VarChar(7)
  name       String   @db.VarChar(50)
  code       String   @unique @db.VarChar(20)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  variants ProductVariant[]

  @@map("color")
}

model ProductVariant {
  id                Int       @id @default(autoincrement())
  slug              String    @unique @db.VarChar(255)
  physical_quantity Int       @default(0)
  reserved_quantity Int       @default(0)
  unit_price        Decimal   @db.Decimal(10, 2)
  discount_percent  Decimal   @default(0) @db.Decimal(5, 2)
  is_default        Boolean   @default(false)
  size_id           Int
  color_id          Int
  product_id        Int
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  size        Size            @relation(fields: [size_id], references: [id])
  color       Color           @relation(fields: [color_id], references: [id])
  product     Product         @relation(fields: [product_id], references: [id])
  images      ProductImage[]
  order_items OrderItem[]

  @@map("product_variant")
}

model ProductImage {
  id                 Int      @id @default(autoincrement())
  image_url          String   @db.VarChar(255)
  alt_text           String?  @db.VarChar(255)
  display_order      Int      @default(0)
  product_variant_id Int
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  product_variant ProductVariant @relation(fields: [product_variant_id], references: [id])

  @@map("product_image")
}
